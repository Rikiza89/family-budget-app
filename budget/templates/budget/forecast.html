{% extends 'budget/base.html' %}
{% load i18n %}

{% block content %}
<div class="p-4">
    <h2 class="text-2xl font-bold mb-6">ğŸ“ˆ {% trans "å°†æ¥äºˆæ¸¬" %}</h2>

    <!-- Year selector -->

<div class="bg-white p-4 rounded-lg shadow mb-6">
    <label class="block text-sm font-medium mb-2">{% trans "äºˆæ¸¬æœŸé–“" %}</label>
    <div class="flex gap-2 items-center">
        <input type="number" id="yearSpinner" value="{{ forecast_years }}"
               min="1" max="60" step="1"
               class="flex-1 p-3 border-2 rounded-lg text-lg text-center font-bold">
        <span class="text-gray-600">{% trans "å¹´" %}</span>
    </div>
</div>

    <!-- Current Status -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
        <h3 class="font-bold mb-4">{% trans "ç¾åœ¨ã®è²¯è“„" %}</h3>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-600">{% trans "ç¾é‡‘è²¯è“„" %}</p>
                <p class="text-2xl font-bold text-purple-600">Â¥{{ total_cash_savings|floatformat:0 }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">{% trans "ä¿é™ºç©ç«‹" %}</p>
                <p class="text-2xl font-bold text-green-600">Â¥{{ total_insurance|floatformat:0 }}</p>
            </div>
        </div>
    </div>

    <!-- Forecast Chart -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
        <h3 class="font-bold mb-4">{{ forecast_years }}{% trans "å¹´å¾Œã®äºˆæ¸¬" %}</h3>
        <canvas id="forecastChart" style="max-height: 350px;"></canvas>
    </div>

    <!-- Annual Averages -->
    <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="font-bold mb-4">{% trans "å¹´å¹³å‡ï¼ˆéå»12ãƒ¶æœˆï¼‰" %}</h3>
        <div class="space-y-2">
            <div class="flex justify-between">
                <span>{% trans "ç¾é‡‘è²¯è“„" %}</span>
                <span class="font-bold text-purple-600">Â¥{{ avg_cash_saving|floatformat:0 }}</span>
            </div>
            <div class="flex justify-between">
                <span>{% trans "ä¿é™ºç©ç«‹" %}</span>
                <span class="font-bold text-green-600">Â¥{{ avg_insurance|floatformat:0 }}</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const spinner = document.getElementById('yearSpinner');
let updateTimer;

function updateForecast() {
    clearTimeout(updateTimer);
    updateTimer = setTimeout(() => {
        window.location.href = '?years=' + spinner.value;
    }, 1000); // Auto-update after 1 second of no change
}

// Mouse wheel
spinner.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -1 : 1;
    let newValue = parseInt(spinner.value) + delta;
    newValue = Math.max(1, Math.min(60, newValue));
    spinner.value = newValue;
    updateForecast();
});

// Touch swipe
let touchStartY = 0;
spinner.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
});

spinner.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touchY = e.touches[0].clientY;
    const diff = touchStartY - touchY;

    if (Math.abs(diff) > 20) {
        const delta = diff > 0 ? 1 : -1;
        let newValue = parseInt(spinner.value) + delta;
        newValue = Math.max(1, Math.min(60, newValue));
        spinner.value = newValue;
        touchStartY = touchY;
        updateForecast();
    }
});

// Manual input
spinner.addEventListener('input', updateForecast);


const forecastData = {{ forecast_data|safe }};

const ctx = document.getElementById('forecastChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: forecastData.map(d => d.year + 'å¹´'),
        datasets: [{
            label: '{% trans "ç¾é‡‘è²¯è“„" %}',
            data: forecastData.map(d => d.cash_savings),
            borderColor: 'rgb(168, 85, 247)',
            backgroundColor: 'rgba(168, 85, 247, 0.1)',
            fill: true
        }, {
            label: '{% trans "ä¿é™ºç©ç«‹" %}',
            data: forecastData.map(d => d.insurance_savings),
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true
        }, {
            label: '{% trans "ç·è²¯è“„" %}',
            data: forecastData.map(d => d.total_savings),
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 3,
            fill: false
        }]
    },
options: {
    responsive: true,
    plugins: { legend: { position: 'bottom' } },
    scales: {
        y: {
            ticks: {
                callback: function(value) {
                    // Format as full yen with commas
                    return 'Â¥' + value.toLocaleString('ja-JP', { maximumFractionDigits: 0 });
                }
            }
        }
    }
}
});
</script>
{% endblock %}